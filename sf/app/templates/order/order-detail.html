{% extends "layout.html" %}
{% block content %}
{% include "nav.html" %}
{% include "_flashing.html" -%}

{% from "_macros.html" import render_field_with_errors, render_select_field %}

<div class="container max-w-4xl mx-auto md:w-1/3" x-data="{ open: false }">

    <div class="mx-3 my-10">
        <!-- order details go here-->
            <div class="w-full border p-6 rounded-lg shadow-lg">
                <div class="flex border-b items-end justify-between">
                    <h1 class="font-bold text-lg"><span class="text-sm font-normal text-gray-500">受注 ID</span> {{ '{:06d}'.format(order.id) }}</h1>
                    <p class="">{{ order.date.strftime('%Y-%m-%d %H:%M') }}</p>    
                </div>
                <p class="font-bold my-3"><span class="text-base font-normal text-gray-500">
                    {{ order.customer_id }}-{{ order.shop_id }}
                </span> {{ order.shop.name }}</p>
                <p class="font-bold my-3">{{ order.shop.prefecture }}{{ order.shop.city }}{{ order.shop.town }}
                    {{ order.shop.address }}{{ order.shop.bldg }}
                </p>
                <p class="font-bold my-3"><span class="text-base font-normal text-gray-500">
                    {{ order.item }}
                </span> {{ order.product.name }}</p>
                <p class="font-bold my-3">{{ order.price }}
                    <span class="text-sm font-normal text-gray-500">円</span>
                </p>
                <p class="font-bold my-3">{{ order.qty }} <span class="text-sm font-normal text-gray-500">個</span></p>
                
                {% if order.exported is none %}
                <div class="mt-8 flex justify-between">
                    <p class="px-3 py-1 text-blue-500 hover:text-blue-800 hover:underline">
                        <a href="/order/{{ order.id }}?mode=edit">編集</a>
                    </p>
                    <div @click="open = true" class="cursor-pointer text-gray-500 text-sm p-1 rounded-full hover:bg-red-100 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                    </div>
                </div>
                {% endif %}

            </div>

            <!-- order requests go here-->
            {% if order.item != 901 %}
                <div class="mt-3 w-full border p-6 rounded-lg shadow-lg">
                    <h2 class="text-base font-bold border-b mb-3">配送に関する依頼</h2>

                    {% if order.date > before2h and not order.request.id %}
                    <form x-data="{ delivery_date : '',
                                    time_range : '',
                                    memo : ''}" action="/order/{{ order.id }}?mode=request" method="POST" >
                        {{ form.csrf_token }}
                        <p class="w-full my-5 text-sm text-gray-500">
                            {{ render_field_with_errors(form.delivery_date, class_="border-b px-5 text-base text-gray-800",
                             min=min_date.strftime('%Y-%m-%d'), max=max_date.strftime('%Y-%m-%d'), **{'x-model' : 'delivery_date'}) }}
                        </p>
                        <p class="w-full my-5 text-sm text-gray-500">
                            {{ render_select_field(form.time_range, class_="px-5 text-base text-gray-800 border-b", **{'x-model' : 'time_range'}) }}
                        </p>
                        <p class="w-full my-5 text-sm text-gray-500">
                            {{ render_select_field(form.memo, class_="mt-3 px-3 text-sm text-gray-800 border-b w-full", placeholder="ドライバーへの依頼 〜15文字"
                            , **{'x-model' : 'memo'}) }}
                        </p>

                        <button type="button" x-on:click="delivery_date || time_range || memo ? $el.closest('form').submit() : alert('依頼事項を入力してから登録して下さい。') " 
                        class="w-full bg-blue-500 text-white px-7 py-1 rounded-full">登録</button>
                    </form>

                    {% elif order.request.id %}
                    <div>
                        <p class="text-sm text-gray-500">指定日<span class="ml-5 text-base text-gray-800 font-bold">{{ order.request.delivery_date or ''}}</span></p>
                        <p class="mt-3 text-sm text-gray-500">時間帯<span class="ml-5 text-base text-gray-800 font-bold">{{ order.request.time_range or ''}}</span></p>
                        <p class="mt-3 text-sm text-gray-500">依頼事項<span class="ml-5 text-sm text-gray-800 font-bold">{{ order.request.memo or ''}}</span></p>
                    </div>

                    {% else %}
                    <p>なし</p>
                    {% endif %}

            </div>
            {% endif %}

            {% if order.shippings %}
            <div class="mt-3 w-full border p-6 rounded-lg shadow-lg">
                <h2 class="text-base font-bold border-b mb-3">出荷</h2>
                {% for shipping in order.shippings %}
                <ul class="mb-3">
                    <li><span class="text-xs text-gray-500">出荷日</span> {{ shipping.shipped_on }}</li>
                    <li><span class="text-xs text-gray-500">お問合せ番号</span> {{ shipping.code }}</li>
                </ul>
                {% endfor %}

            </div>
            {% endif %}
    </div>
    
    <!-- modal content goes here -->
    <div x-show="open" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center">
        <div class="bg-white mx-3 md:mx-0 border p-6 shadow-md">
            <h2 class="font-bold text-sm">受注の削除</h2>
            <p class="text-gray-500 text-sm mt-5">「{{ order.shop.name }}」の受注を削除しようとしています。</p>
            <p class="text-gray-500 text-sm mt-3">削除しますか？</p>
            <p class="font-bold mt-5 text-right">
                <span @click="open = false" class="px-3 py-1 rounded-md text-gray-500 cursor-pointer hover:bg-gray-100">中止</span>
                <span class="ml-8 px-3 py-1 rounded-md text-blue-500 cursor-pointer hover:bg-blue-100">
                    <a href="/order/delete/{{ order.id }}">削除</a></span>
            </p>
        </div>
    </div>
</div>
{% endblock %}
